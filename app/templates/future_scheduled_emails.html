{% extends 'base.html' %}

{% block title %}Future Scheduled Emails Calendar{% endblock %}

{% block styles %}
    {{ super() }}
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #calendar-container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            margin-top: 20px; /* Added for spacing */
        }

        /* --- Custom Event Design --- */
        .fc-event {
            cursor: pointer;
            /* Using a more prominent color to signify total counts */
            border: 1px solid #0056b3 !important;
            background-color: #007bff !important;
            color: #ffffff !important;
            padding: 2px 4px;
        }
        
        .fc-daygrid-event-dot {
            border-color: #0056b3 !important;
        }

        .fc-event-time, .fc-event-title {
            padding: 0 1px;
            font-weight: 600;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <div>
            <h1>Future Scheduled Emails Calendar</h1>
            <p style="margin: 0; color: #555;">An aggregated overview of your upcoming email campaigns.</p>
        </div>
        <div>
            <a href="{{ url_for('reports.reports_dashboard') }}" class="button secondary-button">
                <i class="fas fa-arrow-left"></i> Back to Reports
            </a>
        </div>
    </div>

    <div id="calendar-container">
        <div id="calendar"></div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        
        const calendar = new FullCalendar.Calendar(calendarEl, {
          timeZone: 'Asia/Kolkata', // Set to your local time zone for correct display
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
          },
          initialView: 'timeGridWeek', // Default to week view for better time slot visibility
          
          // --- MODIFICATION START: Simplified 'events' property ---
          // The calendar now fetches all events from a single endpoint without parameters.
          events: '{{ url_for("reports.future_scheduled_emails_events") }}',
          // --- MODIFICATION END ---

          eventDidMount: function(info) {
              // The tooltip remains useful for seeing details on hover.
              let props = info.event.extendedProps;
              tippy(info.el, {
                  content: `
                      <div style="text-align: left; padding: 5px;">
                          <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 5px; border-bottom: 1px solid #6c757d; padding-bottom: 5px;">
                              Scheduled for ${info.event.start.toLocaleTimeString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true })}
                          </div>
                          <div><strong>Total Emails:</strong> ${props.recipientCount}</div>
                          <div><strong>Targeted List(s):</strong> ${props.listNames}</div>
                          <div><strong>Sequence(s):</strong> ${props.sequenceNames}</div>
                      </div>
                  `,
                  allowHTML: true,
              });
          },
        });

        // --- MODIFICATION START: Code for populating and handling the filter has been removed ---
        // The fetch call to '/reports/active-lists' and the event listener for the filter
        // have been deleted as they are no longer necessary.
        // --- MODIFICATION END ---

        calendar.render();
      });
    </script>
{% endblock %}