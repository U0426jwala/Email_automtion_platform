{% extends 'base.html' %}

{% block title %}Edit Campaign - EmailFlow{% endblock %}

{% block head_extra %}
<style>
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .page-header h1 { font-size: 2rem; font-weight: 500; color: #2c3e50; }
    .page-header p { color: #7f8c8d; }
    .btn { border: none; padding: 0.75rem 1.25rem; border-radius: 5px; font-weight: 500; cursor: pointer; transition: background-color 0.3s; text-decoration: none; display: inline-flex; align-items: center; }
    .btn-secondary { background-color: #95a5a6; color: white; }
    .btn-secondary:hover { background-color: #7f8c8d; }
    .btn i { margin-right: 0.5rem; }
    .form-container { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e9ecef; }
    .form-container h2 { font-size: 1.5rem; font-weight: 500; margin-bottom: 1.5rem; border-bottom: 1px solid #dee2e6; padding-bottom: 1rem; }
    .form-group { margin-bottom: 2rem; }
    .form-group label { display: block; margin-bottom: 0.75rem; font-weight: 500; font-size: 1.1rem; }
    .form-group input[type="text"] { width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; }
    .variable-buttons { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
    .variable-buttons .btn { background-color: #eaf4ff; color: #3498db; }
    .variable-buttons .btn:hover { background-color: #d4e9ff; }
    .btn-ai { background-color: #8e44ad; color: white; }
    .btn-ai:hover { background-color: #732d91; }
    .submit-btn { width: 100%; padding: 1rem; font-size: 1.25rem; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
    
    /* CKEditor Decoupled Build Styling */
    #toolbar-container { border-radius: 5px 5px 0 0; border: 1px solid #c4c4c4; border-bottom: none; }
    #editor { border-radius: 0 0 5px 5px; border: 1px solid #c4c4c4; min-height: 250px; padding: 0 1rem; }
    
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-hidden { display: none; }
    .modal-content { background: white; padding: 2rem; border-radius: 8px; display: flex; flex-direction: column; align-items: center; }
    .loader { border: 4px solid #f3f3f3; border-top-color: #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Edit Email Campaign</h1>
        <p>Modify the name, subject, and body of your campaign.</p>
    </div>
    <a href="{{ url_for('campaign.campaigns_list') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>Back to Campaigns
    </a>
</div>

<div class="form-container">
    <h2>Campaign Details</h2>
    <form id="campaign-form" method="POST" action="{{ url_for('campaign.edit_campaign_route', campaign_id=campaign.id) }}">
        <div class="form-group">
            <label for="name">Campaign Name:</label>
            <input type="text" id="name" name="name" required value="{{ campaign.name }}">
        </div>

        <div class="form-group">
            <label for="subject">Email Subject:</label>
            <input type="text" id="subject" name="subject" required value="{{ campaign.subject }}">
        </div>

        <div class="form-group">
            <label>Email Body:</label>
            <div class="variable-buttons">
                <button type="button" class="btn variable-btn" data-name="First Name"><i class="fas fa-user"></i>First Name</button>
                <button type="button" class="btn variable-btn" data-name="Last Name"><i class="fas fa-user-tag"></i>Last Name</button>
                <button type="button" class="btn variable-btn" data-name="Email"><i class="fas fa-at"></i>Email</button>
                <button type="button" class="btn variable-btn" data-name="Company"><i class="fas fa-building"></i>Company</button>
                <button type="button" id="improve-body-btn" class="btn btn-ai"><i class="fas fa-robot"></i>Improve Body (AI)</button>
            </div>
            
            <div id="toolbar-container"></div>
            
            <div id="editor">{{ campaign.body | safe }}</div>

            <input type="hidden" name="body" id="body-input">
            
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 0.5rem;">Tip: Use the buttons above to insert personalization variables.</p>
        </div>
        
        <button type="submit" class="submit-btn">Update Campaign</button>
    </form>
</div>

<div id="ai-loading-modal" class="modal-overlay modal-hidden">
    <div class="modal-content">
        <div class="loader"></div>
        <p>Generating AI content...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/decoupled-document/ckeditor.js"></script>

<script>
    const apiKey = "{{ gemini_api_key }}";
    {% raw %}
    document.addEventListener('DOMContentLoaded', () => {
        let editorInstance; 

        // New initialization for the Decoupled build with custom font options
        DecoupledEditor
            .create(document.querySelector('#editor'), {
                toolbar: {
                    items: [
                        'heading', '|',
                        'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|', 'alignment', '|',
                        'numberedList', 'bulletedList', '|', 'outdent', 'indent', '|', 'link',
                        'insertTable', 'blockQuote', '|', 'undo', 'redo'
                    ]
                },
                fontSize: {
                    options: [ 10, 12, 14, 'default', 18, 20, 22 ],
                    supportAllValues: true
                },
                fontFamily: {
                    options: [
                        'default', 'Arial, Helvetica, sans-serif', 'Courier New, Courier, monospace',
                        'Georgia, serif', 'Lucida Sans Unicode, Lucida Grande, sans-serif',
                        'Tahoma, Geneva, sans-serif', 'Times New Roman, Times, serif',
                        'Trebuchet MS, Helvetica, sans-serif', 'Verdana, Geneva, sans-serif'
                    ],
                    supportAllValues: true
                }
            })
            .then(editor => {
                editorInstance = editor;
                const toolbarContainer = document.querySelector('#toolbar-container');
                toolbarContainer.appendChild(editor.ui.view.toolbar.element);
            })
            .catch(error => {
                console.error('Error initializing CKEditor:', error);
            });

        // Update the form's hidden input before submission
        const campaignForm = document.getElementById('campaign-form');
        const bodyInput = document.getElementById('body-input');
        campaignForm.addEventListener('submit', () => {
            if (editorInstance) {
                bodyInput.value = editorInstance.getData();
            }
        });
        
        // The rest of your script for the buttons
        const variableButtons = document.querySelectorAll('.variable-btn');
        variableButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!editorInstance) return;
                const variableName = button.dataset.name;
                if (variableName) {
                    const fullPlaceholder = `{{${variableName}}}`;
                    editorInstance.model.change(writer => {
                        writer.insertText(fullPlaceholder, editorInstance.model.document.selection.getFirstPosition());
                    });
                }
            });
        });

        const improveBodyBtn = document.getElementById('improve-body-btn');
        improveBodyBtn.addEventListener('click', async () => {
            if (!editorInstance) return;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = editorInstance.getData();
            const content = tempDiv.textContent || tempinnerText || "";
            if (content.trim() === "") {
                alert('Please write some content in the email body before using AI.');
                return;
            }
            if (!apiKey) {
                alert('Gemini API key is not configured.');
                return;
            }
            const aiLoadingModal = document.getElementById('ai-loading-modal');
            aiLoadingModal.classList.remove('modal-hidden');
            try {
                const prompt = `Improve the following email body to be more engaging and persuasive. Retain the original meaning and any placeholders like {{First Name}}. Provide only the improved body content as HTML.\n\nEmail Body:\n${content}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    editorInstance.setData(result.candidates[0].content.parts[0].text.trim());
                } else {
                    throw new Error('Unexpected API response structure.');
                }
            } catch (error) {
                alert('Error improving email body: ' + error.message);
            } finally {
                aiLoadingModal.classList.add('modal-hidden');
            }
        });
    });
    {% endraw %}
</script>
{% endblock %}