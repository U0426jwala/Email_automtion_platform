{% extends 'base.html' %}

{% block title %}SMTP Servers - EmailFlow{% endblock %}

{% block head_extra %}
<style>
    /* --- MODIFICATION START: CSS to hide the form by default --- */
    #add-server-form-card {
        display: none;
    }
    /* --- MODIFICATION END --- */

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1rem;
        margin-top: 2rem;
    }
    #test-connection-status {
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>SMTP Servers</h1>
    <button id="show-form-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add SMTP Server</button>
</div>

<div id="add-server-form-card" class="card">
    <h2>Add SMTP Server</h2>
    <p style="color: #555; margin-top: -1rem; margin-bottom: 2rem;">
        Manage your SMTP server configurations for sending emails.
    </p>

    <form method="POST" action="{{ url_for('smtp.configure') }}">
        <div class="form-grid">
            <div class="form-group">
                <label for="name">Server Name</label>
                <input type="text" id="name" name="name" required placeholder="My SendGrid Account">
            </div>
            <div class="form-group">
                <label for="host">Host</label>
                <input type="text" id="host" name="host" required placeholder="smtp.sendgrid.net">
            </div>
            <div class="form-group">
                <label for="port">Port</label>
                <input type="number" id="port" name="port" required placeholder="587">
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem; padding-top: 2rem;">
                <input type="checkbox" id="use_tls" name="use_tls" checked style="width: auto;">
                <label for="use_tls" style="margin-bottom: 0;">Use SSL/TLS</label>
            </div>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password / API Key</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label for="from_email">From Email</label>
                <input type="email" id="from_email" name="from_email" required placeholder="sender@example.com">
            </div>
            <div class="form-group">
                <label for="from_name">From Name</label>
                <input type="text" id="from_name" name="from_name" placeholder="John Doe">
            </div>
        </div>

        <div class="form-actions">
            <span id="test-connection-status"></span>
            <button type="button" id="test-connection-btn" class="btn btn-secondary">Test Connection</button>
            <button type="button" id="cancel-btn" class="btn btn-light">Cancel</button>
            <button type="submit" class="btn btn-primary">Save SMTP Server</button>
        </div>
    </form>
</div>

{% if not configs %}
<div class="card" style="text-align: center;">
    <h3 style="color: #555;">No SMTP Servers</h3>
    <p>You haven't added any SMTP servers yet. Add one to start sending emails.</p>
</div>
{% else %}
<div class="card">
    <h2>Saved Servers</h2>
    <table style="width: 100%; text-align: left; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="padding: 0.75rem;">Name</th>
                <th style="padding: 0.75rem;">Host</th>
                <th style="padding: 0.75rem;">From Email</th>
                <th style="padding: 0.75rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for config in configs %}
            <tr>
                <td style="padding: 0.75rem; border-top: 1px solid #eee;">{{ config.name }}</td>
                <td style="padding: 0.75rem; border-top: 1px solid #eee;">{{ config.host }}</td>
                <td style="padding: 0.75rem; border-top: 1px solid #eee;">{{ config.from_name }} &lt;{{ config.from_email }}&gt;</td>
                <td style="padding: 0.75rem; border-top: 1px solid #eee;">
                    <form action="{{ url_for('smtp.delete', config_id=config.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this configuration? This action cannot be undone.');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                    </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.getElementById('test-connection-btn').addEventListener('click', async () => {
    const statusEl = document.getElementById('test-connection-status');
    const btn = document.getElementById('test-connection-btn');
    
    const data = {
        host: document.getElementById('host').value,
        port: document.getElementById('port').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        use_tls: document.getElementById('use_tls').checked
    };

    if (!data.host || !data.port || !data.username || !data.password) {
        alert('Please fill in Host, Port, Username, and Password to test the connection.');
        return;
    }

    statusEl.textContent = 'Testing...';
    statusEl.style.color = '#555';
    btn.disabled = true;

    try {
        const response = await fetch("{{ url_for('smtp.test_connection') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        const result = await response.json();
        
        if (result.success) {
            statusEl.textContent = result.message;
            statusEl.style.color = 'var(--success-color)';
        } else {
            statusEl.textContent = `Failed: ${result.message}`;
            statusEl.style.color = 'var(--danger-color)';
        }
    } catch (error) {
        statusEl.textContent = 'An error occurred during the test.';
        statusEl.style.color = 'var(--danger-color)';
    } finally {
        btn.disabled = false;
    }
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const showFormBtn = document.getElementById('show-form-btn');
        const formCard = document.getElementById('add-server-form-card');
        const cancelBtn = document.getElementById('cancel-btn');

        // When the "+ Add SMTP Server" button is clicked...
        showFormBtn.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent the link from jumping the page
            formCard.style.display = 'block'; // Show the form card
            showFormBtn.style.display = 'none'; // Hide the button
        });

        // When the "Cancel" button inside the form is clicked...
        cancelBtn.addEventListener('click', () => {
            formCard.style.display = 'none'; // Hide the form card
            showFormBtn.style.display = 'inline-flex'; // Show the main button again
        });
    });
</script>
{% endblock %}