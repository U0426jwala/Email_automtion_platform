{% extends 'base.html' %}

{% block title %}Reports Dashboard{% endblock %}

{% block content %}
    <style>
        .stat-card--linkable {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative; /* Needed for positioning the link */
            padding-bottom: 40px; /* Add space for the link at the bottom */
        }
        .stat-card--linkable:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            cursor: pointer;
        }
        /* Style for the new, always-visible link */
        .stat-card-footer-link {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            color: #007bff;
            transition: background-color 0.2s;
            border-bottom-left-radius: 8px; /* Match card's border-radius */
            border-bottom-right-radius: 8px; /* Match card's border-radius */
        }
        .stat-card--linkable:hover .stat-card-footer-link {
            background-color: #e2e6ea;
        }
        .stat-card-footer-link i {
            margin-left: 5px;
            transition: transform 0.2s;
        }
        .stat-card--linkable:hover .stat-card-footer-link i {
            transform: translateX(4px);
        }
    </style>
    <div class="page-header">
        <div>
            <h1>Reports Dashboard</h1>
            <p style="margin: 0; color: #555;">An overview of your email sending activity.</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-paper-plane"></i></div>
            <div class="stat-value" id="total-sent">{{ stats.total_sent }}</div>
            <div class="stat-label">Total Emails Sent</div>
        </div>
        
        <a href="{{ url_for('reports.future_scheduled_emails') }}" style="text-decoration: none; color: inherit;">
            <div class="stat-card stat-card--linkable">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-value" id="total-scheduled">{{ stats.total_scheduled }}</div>
                <div class="stat-label">Emails Scheduled (Future)</div>
                <div class="stat-card-footer-link">
                    View Details <i class="fas fa-arrow-right"></i>
                </div>
            </div>
        </a>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-value" id="total-contacts">{{ stats.total_contacts }}</div>
            <div class="stat-label">Total Contacts</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-list-ul"></i></div>
            <div class="stat-value" id="total-lists">{{ stats.total_lists }}</div>
            <div class="stat-label">Total Number of Lists</div>
        </div>
    </div>
    
    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); max-width: 900px; margin-top: 2rem; margin-bottom: 2.5rem;">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
            <div class="stat-value" id="sent-last-24h">{{ stats.sent_last_24h }}</div>
            <div class="stat-label">Emails Sent (Last 24 Hours)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
            <div class="stat-value">{{ stats.sent_monthly }}</div>
            <div class="stat-label">Total Emails Sent Monthly</div>
            <form method="GET" action="{{ url_for('reports.reports_dashboard') }}" class="month-selector-form" style="margin-top: 1rem;">
                <select name="month" onchange="this.form.submit()">
                    {% for num, name in months %}<option value="{{ num }}" {% if num == selected_month %}selected{% endif %}>{{ name }}</option>{% endfor %}
                </select>
                <select name="year" onchange="this.form.submit()">
                     {% for year in years %}<option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>{% endfor %}
                </select>
            </form>
        </div>
        <div class="stat-card">
             <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="stat-value">{{ stats.scheduled_monthly }}</div>
            <div class="stat-label">Total Emails Scheduled Monthly</div>
             <form method="GET" action="{{ url_for('reports.reports_dashboard') }}" class="month-selector-form" style="margin-top: 1rem;">
                <select name="month" onchange="this.form.submit()">
                    {% for num, name in months %}<option value="{{ num }}" {% if num == selected_month %}selected{% endif %}>{{ name }}</option>{% endfor %}
                </select>
                <select name="year" onchange="this.form.submit()">
                     {% for year in years %}<option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>{% endfor %}
                </select>
            </form>
        </div>
    </div>

    <div class="card">
        <h2 style="margin-top:0;">Bounced Email Suppression List</h2>
        <p style="color: #555; margin-top: -1rem; margin-bottom: 2rem;">
            Emails sent to these addresses have failed. The application will automatically stop sending to them.
        </p>
        <div class="table-container" style="box-shadow: none; border: 1px solid #ddd;">
            <table>
                <thead>
                    <tr>
                        <th>Email Address</th>
                        <th>Date Recorded</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bounce in bounced_emails %}
                    <tr>
                        <td>{{ bounce.email }}</td>
                        <td>{{ bounce.bounced_at.strftime('%Y-%m-%d %H:%M:%S') if bounce.bounced_at else 'N/A' }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="2" style="text-align: center; padding: 2rem;">No bounced emails recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    function fetchAndUpdateStats() {
        fetch("{{ url_for('reports.reports_data') }}")
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-sent').textContent = data.total_sent;
                document.getElementById('total-scheduled').textContent = data.total_scheduled;
                document.getElementById('total-contacts').textContent = data.total_contacts;
                document.getElementById('total-lists').textContent = data.total_lists;
                document.getElementById('sent-last-24h').textContent = data.sent_last_24h;
                console.log('Dashboard stats updated automatically.');
            })
            .catch(error => console.error('Error fetching stats:', error));
    }
    setInterval(fetchAndUpdateStats, 30000);
</script>
{% endblock %}