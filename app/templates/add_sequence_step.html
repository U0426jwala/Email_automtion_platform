{% extends 'base.html' %}

{% block title %}Add Step to {{ sequence.name }}{% endblock %}

{% block head_extra %}
<style>
    /* Styles from create_campaign.html for editor buttons */
    .variable-buttons { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
    .variable-buttons .btn { background-color: #eaf4ff; color: #3498db; }
    .variable-buttons .btn:hover { background-color: #d4e9ff; }
    .btn { border: none; padding: 0.75rem 1.25rem; border-radius: 5px; font-weight: 500; cursor: pointer; transition: background-color 0.3s; text-decoration: none; display: inline-flex; align-items: center; }
    .btn i { margin-right: 0.5rem; }

    /* CKEditor Decoupled Build Styling */
    #toolbar-container { border-radius: 5px 5px 0 0; border: 1px solid #c4c4c4; border-bottom: none; }
    #editor { border-radius: 0 0 5px 5px; border: 1px solid #c4c4c4; min-height: 150px; padding: 0 1rem; }
</style>
{% endblock %}

{% block content %}
<style>
    /* Styles for the email editor */
    .quoted-reply-header { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e0e0e0; font-size: 0.9rem; color: #666; }
    .quoted-reply-header strong { font-weight: 600; color: #333; }

    /* --- Toggle Switch CSS --- */
    .toggle-container { display: flex; align-items: center; gap: 15px; margin-top: 1.5rem; background-color: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #dee2e6; }
    .toggle-label { margin-bottom: 0; font-weight: 500; cursor: pointer; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #007bff; }
    input:checked + .slider:before { transform: translateX(22px); }
    
</style>

<div style="max-width: 700px; margin: auto;">
    <div class="card">
        <h1 style="text-align: center;">Add New Step</h1>
        <p style="text-align: center; color: #555;">To sequence: <strong>{{ sequence.name }}</strong></p>
        <hr style="border: none; border-top: 1px solid #ecf0f1; margin: 1.5rem 0;">

        <form id="sequence-step-form" method="POST">
            <div class="form-group">
                <label for="editor" style="font-weight: 600;">Reply Content</label>
                
                <div class="variable-buttons">
                    <button type="button" class="btn variable-btn" data-name="First Name"><i class="fas fa-user"></i>First Name</button>
                    <button type="button" class="btn variable-btn" data-name="Last Name"><i class="fas fa-user-tag"></i>Last Name</button>
                    <button type="button" class="btn variable-btn" data-name="Email"><i class="fas fa-at"></i>Email</button>
                    <button type="button" class="btn variable-btn" data-name="Company"><i class="fas fa-building"></i>Company</button>
                </div>
                
                <div id="toolbar-container"></div>
                <div id="editor">
                    <p></p>
                </div>
                <input type="hidden" name="reply_body" id="body-input">


                <div class="quoted-reply-header">
                    <p style="margin: 0;"><strong>From:</strong> You</p>
                    <p style="margin: 0;"><strong>Subject:</strong> Re: {{ previous_subject or 'Previous Email Subject' }}</p>
                    <hr style="margin: 0.5rem 0; border-color: #e0e0e0;">
                    <p style="margin: 0;">[Previous email content will appear here]</p>
                </div>
            </div>

            <div class="form-group" style="margin-top: 1.5rem;">
                <label for="schedule_time">Schedule Date & Time</label>
                <input type="datetime-local" id="schedule_time" name="schedule_time" class="form-control" required>
            </div>
            
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" name="is_re_reply" checked>
                    <span class="slider"></span>
                </label>
                <label class="toggle-label">Reply to Previous Email (creates a thread)</label>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                <a href="{{ url_for('sequence.manage_sequence', sequence_id=sequence.id) }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary" style="padding: 0.8rem 2.5rem;">Add Step</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/decoupled-document/ckeditor.js"></script>

<script>
    {% raw %}
    document.addEventListener('DOMContentLoaded', () => {
        let editorInstance; 

        // Initialization for the Decoupled build with custom font options
        DecoupledEditor
            .create(document.querySelector('#editor'), {
                toolbar: {
                    items: [
                        'heading', '|',
                        'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|', 'alignment', '|',
                        'numberedList', 'bulletedList', '|', 'outdent', 'indent', '|', 'link',
                        'insertTable', 'blockQuote', '|', 'undo', 'redo'
                    ]
                },
                fontSize: {
                    options: [ 10, 12, 14, 'default', 18, 20, 22 ],
                    supportAllValues: true
                },
                fontFamily: {
                    options: [
                        'default', 'Arial, Helvetica, sans-serif', 'Courier New, Courier, monospace',
                        'Georgia, serif', 'Lucida Sans Unicode, Lucida Grande, sans-serif',
                        'Tahoma, Geneva, sans-serif', 'Times New Roman, Times, serif',
                        'Trebuchet MS, Helvetica, sans-serif', 'Verdana, Geneva, sans-serif'
                    ],
                    supportAllValues: true
                }
            })
            .then(editor => {
                editorInstance = editor;
                const toolbarContainer = document.querySelector('#toolbar-container');
                toolbarContainer.appendChild(editor.ui.view.toolbar.element);
            })
            .catch(error => {
                console.error('Error initializing CKEditor:', error);
            });

        // Update the form's hidden input before submission
        const sequenceStepForm = document.getElementById('sequence-step-form');
        const bodyInput = document.getElementById('body-input');
        sequenceStepForm.addEventListener('submit', () => {
            if (editorInstance) {
                bodyInput.value = editorInstance.getData();
            }
        });
        
        // Logic for the variable buttons
        const variableButtons = document.querySelectorAll('.variable-btn');
        variableButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!editorInstance) return;
                const variableName = button.dataset.name;
                if (variableName) {
                    const fullPlaceholder = `{{${variableName}}}`;
                    editorInstance.model.change(writer => {
                        writer.insertText(fullPlaceholder, editorInstance.model.document.selection.getFirstPosition());
                    });
                }
            });
        });
    });
    {% endraw %}
</script>
{% endblock %}